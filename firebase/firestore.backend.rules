// Firestore security rules for Timeless
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Validation helpers ---
    
    // Check if user is logged in
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is the owner of the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Check if user has a specific role
    function hasRole(role) {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    // Validation candidate profile data
    function isValidCandidateProfile() {
      return request.resource.data.keys().hasAll(['email', 'fullName', 'role']) &&
             request.resource.data.role == 'candidate' &&
             request.resource.data.email is string &&
             request.resource.data.fullName is string &&
             request.resource.data.email.matches('.*@.*\\..*');
    }
    
    // Validation candidate CV data 
    function isValidCVData() {
      return request.resource.data.keys().hasAll(['fileName', 'fileSize', 'contentType', 'uploadedAt']) &&
             request.resource.data.fileSize <= 10485760 && // 10MB max
             request.resource.data.contentType in ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
    }
    
    // Validation job application data
    function isValidApplication() {
      return request.resource.data.keys().hasAll(['jobId', 'candidateId', 'appliedAt', 'status']) &&
             request.resource.data.status in ['pending', 'reviewed', 'accepted', 'rejected'] &&
             exists(/databases/$(database)/documents/jobs/$(request.resource.data.jobId));
    }

    // --- MAIN COLLECTIONS---
    
    // Users collection
    match /users/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId) && isValidCandidateProfile();
    }
    
    // Candidate profiles collection
    match /candidate_profiles/{candidateId} {
      allow read: if isAuthenticated() && (isOwner(candidateId) || hasRole('recruiter'));
      allow write: if isAuthenticated() && isOwner(candidateId);
      allow create: if isAuthenticated() && isOwner(candidateId);
    }
    
    // CVs collection
    match /cvs/{cvId} {
      allow read: if isAuthenticated() && 
                    (isOwner(resource.data.candidateId) || hasRole('recruiter'));
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.candidateId) && 
                      isValidCVData();
      allow update: if isAuthenticated() && isOwner(resource.data.candidateId);
      allow delete: if isAuthenticated() && isOwner(resource.data.candidateId);
    }
    
    // Job applications
    match /applications/{applicationId} {
      allow read: if isAuthenticated() && 
                    (isOwner(resource.data.candidateId) || hasRole('recruiter'));
      allow create: if isAuthenticated() && 
                      isOwner(request.resource.data.candidateId) && 
                      isValidApplication();
      allow update: if isAuthenticated() && 
                      (isOwner(resource.data.candidateId) || hasRole('recruiter'));
    }
    
    // --- PUBLIC READ COLLECTIONS ---
    
    // Job offers
    match /jobs/{jobId} {
      allow read: if isAuthenticated();
      allow write: if hasRole('recruiter') || hasRole('admin');
    }
    
    // Legagcy job posts
    match /allPost/{postId} {
      allow read: if isAuthenticated();
      allow write: if hasRole('recruiter') || hasRole('admin');
    }
    
    
    // Jobs categories
    match /category/{categoryName}/{jobId} {
      allow read: if isAuthenticated();
      allow write: if hasRole('recruiter') || hasRole('admin');
    }
    
    // --- AUTH RELATED DATA ---
    
    match /Auth/User/register/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // --- ADMIN ONLY DATA ---
    
    match /analytics/{document=**} {
      allow read, write: if hasRole('admin');
    }
    
    // --- DEFAULT RULE ---
    
    // Interdire tout accès par défaut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}