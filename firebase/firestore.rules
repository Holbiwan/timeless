// Firestore rules for Timeless
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- Auth data ---

    match /Auth/User/register/{userId} {

      // User can access own data only
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Validate user registration data
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['Email', 'fullName', 'uid'])
        && request.resource.data.uid == userId
        && request.resource.data.Email == request.auth.token.email;
    }

    // --- Job posts ---

    match /allPost/{jobId} {

      // Read job posts
      allow read: if request.auth != null;

      // Only managers and admins can write
      allow write: if request.auth != null 
        && exists(/databases/$(database)/documents/Auth/User/register/$(request.auth.uid))
        && get(/databases/$(database)/documents/Auth/User/register/$(request.auth.uid))
             .data.role in ['manager', 'admin'];
    }

    // --- Job categories ---

    match /category/{categoryName}/{categoryDocument} {

      // Read categories
      allow read: if request.auth != null;

      // Write restricted to managers
      allow write: if request.auth != null 
        && exists(/databases/$(database)/documents/Auth/User/register/$(request.auth.uid))
        && get(/databases/$(database)/documents/Auth/User/register/$(request.auth.uid))
             .data.role in ['manager', 'admin'];
    }

    // --- Job applications ---

    match /Apply/{userId} {

      // User manages own applications
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Validate application data
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['userName', 'email', 'apply'])
        && request.resource.data.apply == true;
    }

    // --- Bookmarks ---

    match /BookMark/{userId}/BookMark1/{bookmarkId} {

      // User manages own bookmarks
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Chat rooms ---

    match /chatRoom/{chatId} {

      // Chat participants only
      allow read, write: if request.auth != null 
        && request.auth.uid in resource.data.participants;
    }

    match /chatRoom/{chatId}/messages/{messageId} {

      // Chat messages access
      allow read, write: if request.auth != null 
        && request.auth.uid in get(/databases/$(database)/documents/chatRoom/$(chatId))
             .data.participants;
    }

    // --- Public read-only data ---

    match /publicData/{document} {

      // Read-only public data
      allow read: if request.auth != null;
      allow write: if false;
    }

    // --- Default rule ---

    // Block everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}


// ------------------------------------------------------------
// Firebase Storage rules
// ------------------------------------------------------------

service firebase.storage {
  match /b/{bucket}/o {

    // --- User CV files ---

    match /cv/{userId}/{fileName} {

      // User uploads and reads own CV
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // PDF only, max 10MB
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && resource.contentType == 'application/pdf'
        && resource.size < 10 * 1024 * 1024;
    }

    // --- Profile pictures ---

    match /profile_pictures/{userId}/{fileName} {

      // User profile images
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Image only, max 5MB
      allow create: if request.auth != null 
        && request.auth.uid == userId
        && resource.contentType.matches('image/.*')
        && resource.size < 5 * 1024 * 1024;
    }

    // --- Company images ---

    match /company_images/{userId}/{fileName} {

      // Read company images
      allow read: if request.auth != null;

      // Owner upload only
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Default rule ---

    // Block everything else
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
